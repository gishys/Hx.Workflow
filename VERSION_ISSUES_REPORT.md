# æµç¨‹æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶é—®é¢˜æ£€æŸ¥æŠ¥å‘Š

## ğŸ” æ£€æŸ¥èŒƒå›´

- API æ¥å£ä¸­çš„ç‰ˆæœ¬å‚æ•°å¤„ç†
- æµç¨‹å®ä¾‹åˆ›å»ºæ—¶çš„ç‰ˆæœ¬éªŒè¯
- ç‰ˆæœ¬æŸ¥è¯¢é€»è¾‘çš„ä¸€è‡´æ€§
- æ•°æ®ä¸€è‡´æ€§å’Œå¹¶å‘é—®é¢˜

## âš ï¸ å‘ç°çš„é—®é¢˜

### 1. **StartWorkflowInput.Version ç¼ºå°‘éªŒè¯** âš ï¸ é«˜é£é™©

**ä½ç½®**: `WorkflowAppService.cs` ç¬¬ 77 è¡Œ

**é—®é¢˜æè¿°**:

- `StartWorkflowInput.Version` æ²¡æœ‰éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆç‰ˆæœ¬å·ï¼ˆ> 0ï¼‰
- å¦‚æœä¼ å…¥ `Version = 0` æˆ–è´Ÿæ•°ï¼Œä¼šç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå¯èƒ½å¯¼è‡´ï¼š
  - æŸ¥è¯¢åˆ°é”™è¯¯çš„ç‰ˆæœ¬
  - æˆ–è€…æŸ¥è¯¢å¤±è´¥ä½†é”™è¯¯ä¿¡æ¯ä¸å¤Ÿæ˜ç¡®

**å½“å‰ä»£ç **:

```csharp
var entity = await _wkDefinition.GetDefinitionAsync(new Guid(input.Id), input.Version)
    ?? throw new UserFriendlyException(message: $"ä¸å­˜åœ¨Idä¸ºï¼š[{input.Id},{input.Version}]æµç¨‹æ¨¡æ¿ï¼");
```

**å»ºè®®ä¿®å¤**:

```csharp
// éªŒè¯ç‰ˆæœ¬å·
if (input.Version <= 0)
{
    throw new UserFriendlyException(message: $"ç‰ˆæœ¬å·å¿…é¡»å¤§äº0ï¼Œå½“å‰å€¼ï¼š{input.Version}");
}

var entity = await _wkDefinition.GetDefinitionAsync(new Guid(input.Id), input.Version)
    ?? throw new UserFriendlyException(message: $"ä¸å­˜åœ¨Idä¸ºï¼š[{input.Id}], ç‰ˆæœ¬ä¸ºï¼š[{input.Version}]çš„æµç¨‹æ¨¡æ¿ï¼");
```

---

### 2. **GetDefinitionAsync é»˜è®¤ç‰ˆæœ¬å¯èƒ½ä¸å­˜åœ¨** âš ï¸ ä¸­é£é™©

**ä½ç½®**: `HxDefinitionController.cs` ç¬¬ 41 è¡Œ

**é—®é¢˜æè¿°**:

- `GetDefinitionAsync(Guid id, int version = 1)` é»˜è®¤ç‰ˆæœ¬ä¸º 1
- å¦‚æœæ¨¡æ¿çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸æ˜¯ 1ï¼ˆä¾‹å¦‚ä»ç‰ˆæœ¬ 2 å¼€å§‹ï¼‰ï¼Œä¼šè¿”å›é”™è¯¯
- ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“åº”è¯¥ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬å·

**å½“å‰ä»£ç **:

```csharp
[HttpGet]
[Route("details")]
public Task<WkDefinitionDto> GetAsync(Guid id, int version = 1)
{
    return _appService.GetDefinitionAsync(id, version);
}
```

**å»ºè®®ä¿®å¤**:

- æ–¹æ¡ˆ 1ï¼šç§»é™¤é»˜è®¤å€¼ï¼Œå¼ºåˆ¶è¦æ±‚ä¼ å…¥ç‰ˆæœ¬å·
- æ–¹æ¡ˆ 2ï¼šå¦‚æœç‰ˆæœ¬æœªæä¾›ï¼Œè¿”å›æœ€æ–°ç‰ˆæœ¬ï¼ˆä½†éœ€è¦æ˜ç¡®æ–‡æ¡£è¯´æ˜ï¼‰

---

### 3. **GetAsync(Guid id) è¿”å›æœ€æ–°ç‰ˆæœ¬å¯èƒ½å¼•èµ·æ··æ·†** âš ï¸ ä½é£é™©

**ä½ç½®**: `HxDefinitionController.cs` ç¬¬ 30 è¡Œ

**é—®é¢˜æè¿°**:

- `GetAsync(Guid id)` åªè¿”å›æœ€æ–°æœªå½’æ¡£ç‰ˆæœ¬
- å¦‚æœç”¨æˆ·æœŸæœ›è·å–ç‰¹å®šç‰ˆæœ¬ï¼Œå¯èƒ½ä¼šæ··æ·†
- API æ–‡æ¡£éœ€è¦æ˜ç¡®è¯´æ˜æ­¤è¡Œä¸º

**å½“å‰ä»£ç **:

```csharp
[HttpGet]
public Task<WkDefinitionDto?> GetAsync(Guid id)
{
    return _appService.GetAsync(id);
}
```

**å»ºè®®**:

- åœ¨ API æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜æ­¤æ–¹æ³•è¿”å›æœ€æ–°æœªå½’æ¡£ç‰ˆæœ¬
- æˆ–è€…é‡å‘½åä¸º `GetLatestAsync(Guid id)` ä»¥æ˜ç¡®è¯­ä¹‰

---

### 4. **ç‰ˆæœ¬æ³¨å†Œæ£€æŸ¥åœ¨æŸ¥è¯¢ä¹‹å** âœ… å·²ä¿®å¤

**ä½ç½®**: `WorkflowAppService.cs` ç¬¬ 83-95 è¡Œ

**é—®é¢˜æè¿°**:

- ~~å…ˆæŸ¥è¯¢æ•°æ®åº“è·å–æ¨¡æ¿å®šä¹‰~~
- ~~ç„¶åæ£€æŸ¥æ˜¯å¦å·²å½’æ¡£~~
- ~~æœ€åæ‰æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œåˆ°å¼•æ“ï¼ˆåœ¨ `StartWorkflowAsync` ä¸­ï¼‰~~
- ~~å¦‚æœç‰ˆæœ¬æœªæ³¨å†Œåˆ°å¼•æ“ï¼Œé”™è¯¯ä¿¡æ¯ä¸å¤Ÿæ˜ç¡®~~

**ä¿®å¤æ–¹æ¡ˆ**:

1. âœ… åœ¨ `IHxWorkflowManager` æ¥å£ä¸­æ·»åŠ  `IsRegistered` æ–¹æ³•
2. âœ… åœ¨ `HxWorkflowManager` ä¸­å®ç°è¯¥æ–¹æ³•
3. âœ… åœ¨æŸ¥è¯¢æ¨¡æ¿å®šä¹‰åï¼Œç«‹å³æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œåˆ°å¼•æ“
4. âœ… æä¾›æ›´æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…å«æ¨¡æ¿ ID å’Œç‰ˆæœ¬å·

**ä¿®å¤åçš„æµç¨‹**:

1. éªŒè¯ç‰ˆæœ¬å·ï¼ˆç¬¬ 66 è¡Œï¼‰
2. æŸ¥è¯¢æ¨¡æ¿å®šä¹‰ï¼ˆç¬¬ 83 è¡Œï¼‰
3. æ£€æŸ¥æ˜¯å¦å·²å½’æ¡£ï¼ˆç¬¬ 86 è¡Œï¼‰
4. **æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œåˆ°å¼•æ“ï¼ˆç¬¬ 91 è¡Œï¼‰** â† æ–°å¢ï¼Œæå‰æ£€æŸ¥
5. æ£€æŸ¥æƒé™ï¼ˆç¬¬ 96 è¡Œï¼‰
6. è°ƒç”¨ `StartWorkflowAsync`ï¼ˆç¬¬ 100 è¡Œï¼‰

**ä¿®å¤ä»£ç **:

```csharp
// åœ¨ IHxWorkflowManager æ¥å£ä¸­æ·»åŠ 
bool IsRegistered(string id, int version);

// åœ¨ HxWorkflowManager ä¸­å®ç°
public virtual bool IsRegistered(string id, int version)
{
    return _registry.IsRegistered(id, version);
}

// åœ¨ WorkflowAppService.StartAsync ä¸­ä½¿ç”¨
// æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²æ³¨å†Œåˆ°å·¥ä½œæµå¼•æ“ï¼ˆæå‰æ£€æŸ¥ï¼Œæä¾›æ›´æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ï¼‰
if (!_hxWorkflowManager.IsRegistered(input.Id, input.Version))
{
    throw new UserFriendlyException(message: $"æµç¨‹æ¨¡æ¿ Idä¸ºï¼š[{input.Id}]ï¼Œç‰ˆæœ¬ä¸ºï¼š[{input.Version}] æœªæ³¨å†Œåˆ°å·¥ä½œæµå¼•æ“ï¼Œæ— æ³•å¯åŠ¨å®ä¾‹ã€‚è¯·ç¡®ä¿æ¨¡æ¿å·²æ­£ç¡®åˆ›å»ºå¹¶æ³¨å†Œã€‚");
}
```

---

### 5. **GetDefinitionAsync é»˜è®¤ç‰ˆæœ¬å¤„ç†ä¸ä¸€è‡´** âš ï¸ ä½é£é™©

**ä½ç½®**: `WkDefinitionAppService.cs` ç¬¬ 1186 è¡Œ

**é—®é¢˜æè¿°**:

- `GetDefinitionAsync(Guid id, int version = 1)` é»˜è®¤ç‰ˆæœ¬ä¸º 1
- å¦‚æœç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œé”™è¯¯ä¿¡æ¯ä¸å¤Ÿå‹å¥½

**å½“å‰ä»£ç **:

```csharp
public virtual async Task<WkDefinitionDto> GetDefinitionAsync(Guid id, int version = 1)
{
    var entity = await _definitionRespository.GetDefinitionAsync(id, version)
        ?? throw new UserFriendlyException(message: $"Idä¸ºï¼š{id}æ¨¡æ¿ä¸å­˜åœ¨ï¼");
    // ...
}
```

**å»ºè®®**:

- é”™è¯¯ä¿¡æ¯åº”è¯¥åŒ…å«ç‰ˆæœ¬å·ï¼š`$"Idä¸ºï¼š{id}ï¼Œç‰ˆæœ¬ä¸ºï¼š{version}çš„æ¨¡æ¿ä¸å­˜åœ¨ï¼"`
- å¦‚æœç‰ˆæœ¬æœªæä¾›ä¸”é»˜è®¤ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œå¯ä»¥è€ƒè™‘è¿”å›æœ€æ–°ç‰ˆæœ¬

---

## âœ… å·²æ­£ç¡®å¤„ç†çš„åœºæ™¯

### 1. æµç¨‹å®ä¾‹åˆ›å»ºæ—¶ç‰ˆæœ¬è®¾ç½® âœ…

- `HxPersistenceProvider.CreateNewWorkflow` æ­£ç¡®ä½¿ç”¨ `workflow.Version`
- `ToPersistable` æ–¹æ³•æ­£ç¡®è®¾ç½®å®ä¾‹ç‰ˆæœ¬

### 2. ç‰ˆæœ¬å½’æ¡£æ£€æŸ¥ âœ…

- `StartAsync` ä¸­å·²æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å½’æ¡£
- å·²å½’æ¡£ç‰ˆæœ¬ä¸èƒ½ç”¨äºåˆ›å»ºæ–°å®ä¾‹

### 3. æƒé™æ£€æŸ¥ âœ…

- åˆ›å»ºå®ä¾‹å‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™

### 4. é€šè¿‡å®ä¾‹è·å–æ¨¡æ¿å®šä¹‰ âœ…

- æ‰€æœ‰é€šè¿‡ `instance.WkDefinition` è®¿é—®çš„åœ°æ–¹éƒ½æ­£ç¡®
- ç›´æ¥æŸ¥è¯¢æ—¶éƒ½ä½¿ç”¨äº† `instance.Version`

---

## ğŸ”§ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### ä¼˜å…ˆçº§ 1ï¼šé«˜ä¼˜å…ˆçº§ä¿®å¤

1. **æ·»åŠ ç‰ˆæœ¬å·éªŒè¯**

   ```csharp
   // åœ¨ StartAsync æ–¹æ³•å¼€å§‹å¤„æ·»åŠ 
   if (input.Version <= 0)
   {
       throw new UserFriendlyException(message: $"ç‰ˆæœ¬å·å¿…é¡»å¤§äº0ï¼Œå½“å‰å€¼ï¼š{input.Version}");
   }
   ```

2. **æ”¹è¿›é”™è¯¯ä¿¡æ¯**
   - æ‰€æœ‰æ¶‰åŠç‰ˆæœ¬æŸ¥è¯¢çš„é”™è¯¯ä¿¡æ¯éƒ½åº”åŒ…å«ç‰ˆæœ¬å·
   - æä¾›æ›´æ˜ç¡®çš„é”™è¯¯æç¤º

### ä¼˜å…ˆçº§ 2ï¼šä¸­ä¼˜å…ˆçº§ä¼˜åŒ– âœ… å·²ä¿®å¤

1. **ç‰ˆæœ¬æ³¨å†Œæ£€æŸ¥æå‰** âœ…

   ```csharp
   // åœ¨ StartAsync ä¸­ï¼ŒæŸ¥è¯¢æ¨¡æ¿åç«‹å³æ£€æŸ¥æ³¨å†ŒçŠ¶æ€
   if (!_hxWorkflowManager.IsRegistered(input.Id, input.Version))
   {
       throw new UserFriendlyException(message: $"æµç¨‹æ¨¡æ¿ Idä¸ºï¼š[{input.Id}]ï¼Œç‰ˆæœ¬ä¸ºï¼š[{input.Version}] æœªæ³¨å†Œåˆ°å·¥ä½œæµå¼•æ“ï¼Œæ— æ³•å¯åŠ¨å®ä¾‹ã€‚è¯·ç¡®ä¿æ¨¡æ¿å·²æ­£ç¡®åˆ›å»ºå¹¶æ³¨å†Œã€‚");
   }
   ```

2. **API æ¥å£æ”¹è¿›**
   - è€ƒè™‘ç§»é™¤ `GetDefinitionAsync` çš„é»˜è®¤ç‰ˆæœ¬å‚æ•°
   - æˆ–è€…æä¾› `GetLatestAsync` æ–¹æ³•æ˜ç¡®è¯­ä¹‰

### ä¼˜å…ˆçº§ 3ï¼šä½ä¼˜å…ˆçº§æ”¹è¿›

1. **API æ–‡æ¡£å®Œå–„**

   - æ˜ç¡®è¯´æ˜å„ API çš„ç‰ˆæœ¬å‚æ•°è¡Œä¸º
   - è¯´æ˜é»˜è®¤å€¼çš„ä½¿ç”¨åœºæ™¯

2. **æ—¥å¿—è®°å½•**
   - è®°å½•ç‰ˆæœ¬æŸ¥è¯¢æ“ä½œ
   - è®°å½•ç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µ

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [x] API æ¥å£ç‰ˆæœ¬å‚æ•°å¤„ç†
- [x] æµç¨‹å®ä¾‹åˆ›å»ºæ—¶ç‰ˆæœ¬éªŒè¯
- [x] ç‰ˆæœ¬æŸ¥è¯¢é€»è¾‘ä¸€è‡´æ€§
- [x] é”™è¯¯ä¿¡æ¯å®Œæ•´æ€§
- [ ] å¹¶å‘æ§åˆ¶ï¼ˆéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ï¼‰
- [ ] äº‹åŠ¡å¤„ç†ï¼ˆéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ï¼‰

---

## ğŸ“ æ€»ç»“

**ä¸»è¦é—®é¢˜**:

1. âœ… `StartWorkflowInput.Version` ç¼ºå°‘éªŒè¯ï¼ˆé«˜é£é™©ï¼‰- **å·²ä¿®å¤**
2. âœ… ç‰ˆæœ¬æ³¨å†Œæ£€æŸ¥åœ¨æŸ¥è¯¢ä¹‹åï¼ˆä¸­é£é™©ï¼‰- **å·²ä¿®å¤**
3. âœ… é”™è¯¯ä¿¡æ¯ä¸å¤Ÿæ˜ç¡®ï¼ˆä¸­é£é™©ï¼‰- **å·²ä¿®å¤**
4. âš ï¸ é»˜è®¤ç‰ˆæœ¬å¤„ç†å¯èƒ½å¼•èµ·æ··æ·†ï¼ˆä¸­é£é™©ï¼‰- å»ºè®®åœ¨ API æ–‡æ¡£ä¸­è¯´æ˜

**å·²å®Œæˆçš„ä¿®å¤**:

- âœ… æ·»åŠ ç‰ˆæœ¬å·éªŒè¯ï¼Œç¡®ä¿ç‰ˆæœ¬å· > 0
- âœ… æ”¹è¿›é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…å«ç‰ˆæœ¬å·
- âœ… æå‰æ£€æŸ¥ç‰ˆæœ¬æ³¨å†ŒçŠ¶æ€ï¼Œæä¾›æ›´æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- âœ… åœ¨ `IHxWorkflowManager` æ¥å£ä¸­æ·»åŠ  `IsRegistered` æ–¹æ³•

**å»ºè®®**:

- è€ƒè™‘ä¼˜åŒ– API æ¥å£è®¾è®¡ï¼Œæ˜ç¡®ç‰ˆæœ¬å‚æ•°è¡Œä¸º
- å®Œå–„ API æ–‡æ¡£ï¼Œè¯´æ˜é»˜è®¤å€¼çš„ä½¿ç”¨åœºæ™¯
